# Story 1.2: Markdown Code Block Detection

Status: Ready for Review

## Story
**As a** user,
**I want** the plugin to identify shell code blocks in markdown files,
**so that** I can target specific blocks for execution.

## Acceptance Criteria
1. Plugin correctly identifies fenced code blocks with ```bash, ```sh, or ``` (no language specified)
2. Plugin can determine the current code block based on cursor position
3. Plugin ignores non-shell code blocks (```python, ```javascript, etc.)
4. Plugin handles nested code blocks within list items or blockquotes
5. Plugin provides feedback when cursor is not in a valid code block

## Tasks / Subtasks
- [x] Implement block parser in `lua/markdownrun/markdown.lua`
  - [x] Recognize fenced code blocks and supported languages (bash/sh/none)
  - [x] Handle nesting within lists and blockquotes
  - [x] Expose API: find current block by cursor; list all shell blocks
- [x] Compute stable `block_id` and `content_hash` per architecture
- [x] Provide user feedback when not in a runnable block via echo/notify
- [x] Unit tests for varied markdown structures

## Dev Notes
- Detection rules and block metadata are covered in "4. Markdown Parsing and Block Identification". [Source: architecture.md#4.-Markdown-Parsing-and-Block-Identification]
- Block identity must be stable across edits unless content changes; use provided hashing guidance. [Source: architecture.md#4.-Markdown-Parsing-and-Block-Identification]

### Testing
- Add unit tests for edge cases (indented code blocks in lists, blockquotes). See "13. Testing Strategy". [Source: architecture.md#13.-Testing-Strategy]

## Dev Agent Record

### Agent Model Used
- dev (James)

### Debug Log References
- .ai/debug-log.md

### File List
- `lua/markdownrun/markdown.lua` (new)
- `scripts/test_markdown.lua` (new)

### Completion Notes
- Implemented fenced code block detection supporting `bash`, `sh`, and no-language blocks
- Handles nested contexts (lists, blockquotes) by stripping markdown prefixes prior to fence matching
- Exposes APIs: `get_shell_blocks`, `get_current_block`, and a helper notifier
- Stable `block_id` equals `content_hash` computed via `vim.fn.sha256` over normalized content
- Added headless tests executed via Neovim to validate detection and current-block lookup

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-08 | 0.1 | Initial draft | PO Agent |
