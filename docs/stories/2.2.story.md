# Story 2.2: Environment Persistence System

Status: Done

## Story
**As a** user,
**I want** environment variables and directory changes to persist between command executions,
**so that** I can build complex workflows that depend on previous commands.

## Acceptance Criteria
1. Environment variables set in one command are available in subsequent commands
2. Directory changes (cd commands) persist for future executions
3. PATH modifications and exports are maintained across executions
4. Plugin tracks the current working directory and displays it
5. Environment state resets only when explicitly requested or session ends
6. Plugin handles environment corruption gracefully

## Tasks / Subtasks
- [x] Implement session model in `lua/markdownrun/state.lua`
- [x] Parse-and-apply fast path for `cd`, `export`, `VAR=...`
- [ ] Optional hybrid reconciliation via subshell env dump
- [x] Provide `:MarkdownRunEnv` and `:MarkdownRunReset`
- [x] Display current CWD in popup/result

## Dev Notes
- Session state and capture strategies are in "5. Session State Model". [Source: architecture.md#5.-Session-State-Model]
- Commands and config flags in "9. Commands, Keymaps, and Config". [Source: architecture.md#9.-Commands,-Keymaps,-and-Config]

### Testing
- Unit: env delta merge; cwd persistence; reset behavior; corruption handling. [Source: architecture.md#13.-Testing-Strategy]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-08 | 0.1 | Initial draft | PO Agent |
| 2025-08-08 | 0.2 | Implemented session state, env/cwd persistence fast-path, env/reset commands | dev.mdc |
